<div class="connections-container">

  <div class="header-section">
    <h1 class="title-heading-2">
      {{ agencyEmail() }} is requesting access to
      <span class="platforms">{{ requestedPlatformsText() }}</span>
    </h1>
  </div>

  <div class="stepper-section">
    <mat-stepper #stepper
                 [linear]="isLinear()"
                 [selectedIndex]="currentStepIndex()"
                 orientation="horizontal"
                 labelPosition="bottom"
                 class="connection-stepper">

      @for (step of connectionSteps(); track step.id) {
        <mat-step [completed]="step.completed"
                  [editable]="!isLinear() || isStepAccessible($index)"
                  class="connection-step">

          <ng-template matStepLabel>
            {{ step.title }}
          </ng-template>

          @switch (step.id) {

            @case ('connect') {
              <div class="step-content">
                <app-connect-accounts [connectionLink]="connectionLink()"
                                      [agencyEmail]="agencyEmail()"
                                      [enabledGoogleServicesNames]="enabledGoogleServicesNames()"
                                      [enabledFacebookServicesNames]="enabledFacebookServicesNames()"
                                      [accessType]="accessType()"
                                      (connectionStatusChanged)="onConnectionStatusChanged($event)" />

                <div class="step-actions">
                  @if (!hasValidConnections()) {
                    <span class="connection-warning">
                      Please connect at least one platform to continue
                    </span>
                  }
                  <button (click)="nextStep()"
                          mat-flat-button
                          [disabled]="!hasValidConnections()"
                          [attr.title]="!hasValidConnections() ? 'Please connect at least one platform before proceeding' : null">
                    {{ nextButtonText() }}
                  </button>
                </div>
              </div>
            }
            @case ('confirm') {
              <div class="step-content">
                <app-confirm-access [connectionLink]="connectionLink()"
                                    [agencyEmail]="agencyEmail()"
                                    [accessType]="accessType()"
                                    [enabledGoogleServicesNames]="enabledGoogleServicesNames()"
                                    [enabledFacebookServicesNames]="enabledFacebookServicesNames()" />

                <div class="step-actions">
                  @if (!canProceedToStep2()) {
                    <span class="connection-warning">
                      Please grant at least one successful access to continue
                    </span>
                  }
                  <button mat-button
                          (click)="nextStep()"
                          [disabled]="!canProceedToStep2()"
                          [attr.title]="!canProceedToStep2() ? 'Please grant at least one successful access before proceeding' : null"
                          class="button-medium">
                    {{ nextButtonText() }}
                  </button>
                </div>
              </div>
            }
            @case ('connected') {
              <div class="step-content success">
                <app-access-outcome (resetConnection)="onResetConnection()" />
              </div>
            }
          }
        </mat-step>
      }
    </mat-stepper>
  </div>

</div>
