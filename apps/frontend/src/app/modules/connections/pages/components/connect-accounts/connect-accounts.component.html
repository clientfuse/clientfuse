<div class="connect-accounts-container">

  <app-instruction-step>
    <div slot="header">
      <h2 class="subtitle-medium">Requested Accounts</h2>
    </div>

    <div slot="content">
      <div class="requested-accounts-list">

        @if (hasNoServiceRequests()) {
          <div class="no-requests-message">
            <p>No service access requests found</p>
          </div>
        } @else {
          @if (facebookServicesText()) {
            <div class="account-item">
              <div class="account-icon">
                <img src="./assets/icons/meta.svg" alt="Meta" class="provider-icon" />
              </div>
              <div class="account-details">
                <div class="account-title">
                  <span class="account-name body-strong">Meta</span>
                  <span class="account-types">{{ facebookServicesText() }}</span>
                </div>
              </div>
            </div>
          }

          @if (googleServicesText()) {
            <div class="account-item">
              <div class="account-icon">
                <img src="./assets/icons/google.svg" alt="Google" class="provider-icon" />
              </div>
              <div class="account-details">
                <div class="account-title">
                  <span class="account-name body-strong">Google</span>
                  <span class="account-types">{{ googleServicesText() }}</span>
                </div>
              </div>
            </div>
          }
        }

      </div>
    </div>
  </app-instruction-step>

  <app-instruction-step>
    <div slot="header">
      <h2 class="subtitle-medium">Request details</h2>
    </div>

    <div slot="content">
      <app-request-details [connectionSettings]="connectionSettings()"
                           [accessType]="accessType()"
                           [enabledGoogleServicesNames]="enabledGoogleServicesNames()"
                           [enabledFacebookServicesNames]="enabledFacebookServicesNames()" />
    </div>
  </app-instruction-step>

  <div class="connection-actions">

    @if (facebookServicesText()) {
      <app-island [variant]="'neutral'">
        <div class="provider-header">
          <img src="./assets/icons/meta.svg" alt="Meta" class="provider-icon-large" />
          <h3 class="subtitle-medium">Meta</h3>
        </div>

        @if (metaConnectionStatus() === 'disconnected') {
          <div class="connection-content">
            <p>Let's start by connecting Facebook</p>

            <button type="button"
                    class="facebook-connect-btn"
                    (click)="connectFacebook()"
                    [disabled]="metaConnectionStatus() === 'pending'">
              <img src="./assets/icons/facebook.svg" alt="Facebook" class="facebook-icon" />
              Connect Facebook
            </button>

            <p class="connection-alternative body-smaller-text">
              Or
              <button class="link link-blue click-target-helper"
                      (click)="skipFacebook()"
                      [disabled]="metaConnectionStatus() === 'pending'">continue without granting Facebook access
              </button>
            </p>
          </div>
        } @else if (metaConnectionStatus() === 'pending') {
          <div class="connection-status pending">
            <mat-icon class="status-icon">hourglass_empty</mat-icon>
            <span class="status-text">Connecting to Facebook...</span>
          </div>
        } @else if (metaConnectionStatus() === 'connected') {
          <div class="connection-status connected">
            <mat-icon class="status-icon">check_circle</mat-icon>
            <span class="status-text">Connected to Facebook</span>
            <button type="button" class="link link-blue body-smaller-text click-target-helper" (click)="editConnection('meta')">(edit)
            </button>
          </div>
        } @else if (metaConnectionStatus() === 'skipped') {
          <div class="connection-status skipped">
            <mat-icon class="status-icon">close</mat-icon>
            <span class="status-text">Skipped Facebook</span>
            <button type="button" class="link link-blue click-target-helper body-smaller-text" (click)="editConnection('meta')">(edit)
            </button>
          </div>
        }
      </app-island>
    }

    @if (googleServicesText()) {
      <app-island [variant]="'neutral'">
        <div class="google-connection-island-content">
          <div class="provider-header">
            <img src="./assets/icons/google.svg" alt="Google" class="provider-icon-large" />
            <h3 class="subtitle-medium">Google</h3>
          </div>

          @if (googleConnectionStatus() === 'disconnected') {
            <div class="connection-content">
              <asl-google-signin-button
                type="standard"
                size="large"
                theme="outline"
                text="signin_with"
                shape="rectangular"
                (click)="connectGoogle()">
              </asl-google-signin-button>

              <p class="google-disclaimer">
                Our use and transfer of information received from Google to any other app
                adheres to the
                <a href="https://developers.google.com/terms/api-services-user-data-policy#additional_requirements_for_specific_api_scopes"
                   target="_blank"
                   class="link link-blue click-target-helper">
                  Google API Services User Data Policy</a>, including the Limited Use requirements.
              </p>
              
              <p class="connection-alternative body-smaller-text">
                Or
                <button class="link link-blue click-target-helper"
                        (click)="skipGoogle()"
                        [disabled]="googleConnectionStatus() === 'pending'">continue without granting Google access
                </button>
              </p>
            </div>
          } @else if (googleConnectionStatus() === 'pending') {
            <div class="connection-status pending">
              <mat-icon class="status-icon">hourglass_empty</mat-icon>
              <span class="status-text">Connecting to Google...</span>
            </div>
          } @else if (googleConnectionStatus() === 'connected') {
            <div class="connection-status connected">
              <mat-icon class="status-icon">check_circle</mat-icon>
              <span class="status-text">Connected to Google</span>
              <button type="button" class="link link-blue body-smaller-text click-target-helper" (click)="editConnection('google')">(edit)
              </button>
            </div>

            @if (isLoadingGoogleData()) {
              <app-island [variant]="'info'" [borderAccent]="true">
                <p>Loading Google accounts data...</p>
              </app-island>
            }

            @if (googleError()) {
              <app-island [variant]="'error'" [borderAccent]="true">
                <p class="error-text">{{ googleError() }}</p>
              </app-island>
            }

            @if (googleConnectionData()) {
              <app-island [variant]="'info'">
                <div class="user-info">
                  <p class="body-smaller-text"><strong>Email:</strong> {{ googleConnectionData()?.user?.email }}</p>
                  <p class="body-smaller-text"><strong>Name:</strong> {{ googleConnectionData()?.user?.name }}</p>
                </div>
              </app-island>
            }

            @if (googleConnectionData()?.accounts) {
              <app-island [variant]="'neutral'">
                <p class="subtitle-smaller">Available Accounts:</p>
                <div class="accounts-list">
                  @if (googleConnectionData()?.accounts?.googleAnalyticsAccounts?.length) {
                    <div class="account-section">
                      <p class="body-smaller-text"><strong>Google
                                                           Analytics:</strong> {{ googleConnectionData()?.accounts?.googleAnalyticsAccounts?.length }}
                        account(s)</p>
                    </div>
                  }
                  @if (googleConnectionData()?.accounts?.googleAdsAccounts?.length) {
                    <div class="account-section">
                      <p class="body-smaller-text"><strong>Google
                                                           Ads:</strong> {{ googleConnectionData()?.accounts?.googleAdsAccounts?.length }}
                        account(s)</p>
                    </div>
                  }
                  @if (googleConnectionData()?.accounts?.googleTagManagers?.length) {
                    <div class="account-section">
                      <p class="body-smaller-text"><strong>Tag
                                                           Manager:</strong> {{ googleConnectionData()?.accounts?.googleTagManagers?.length }}
                        account(s)</p>
                    </div>
                  }
                  @if (googleConnectionData()?.accounts?.googleSearchConsoles?.length) {
                    <div class="account-section">
                      <p class="body-smaller-text"><strong>Search
                                                           Console:</strong> {{ googleConnectionData()?.accounts?.googleSearchConsoles?.length }}
                        site(s)</p>
                    </div>
                  }
                  @if (googleConnectionData()?.accounts?.googleMerchantCenters?.length) {
                    <div class="account-section">
                      <p class="body-smaller-text"><strong>Merchant
                                                           Center:</strong> {{ googleConnectionData()?.accounts?.googleMerchantCenters?.length }}
                        account(s)</p>
                    </div>
                  }
                  @if (googleConnectionData()?.accounts?.googleMyBusinessAccounts?.length) {
                    <div class="account-section">
                      <p class="body-smaller-text"><strong>My
                                                           Business:</strong> {{ googleConnectionData()?.accounts?.googleMyBusinessAccounts?.length }}
                        account(s)</p>
                    </div>
                  }
                  @if (googleConnectionData()?.accounts?.googleMyBusinessLocations?.length) {
                    <div class="account-section">
                      <p class="body-smaller-text"><strong>My Business
                                                           Locations:</strong> {{ googleConnectionData()?.accounts?.googleMyBusinessLocations?.length }}
                        location(s)</p>
                    </div>
                  }
                </div>
              </app-island>
            }
          } @else if (googleConnectionStatus() === 'skipped') {
            <div class="connection-status skipped">
              <mat-icon class="status-icon">close</mat-icon>
              <span class="status-text">Skipped Google</span>
              <button type="button" class="link link-blue click-target-helper body-smaller-text" (click)="editConnection('google')">(edit)
              </button>
            </div>
          }
        </div>
      </app-island>
    }

  </div>

</div>
