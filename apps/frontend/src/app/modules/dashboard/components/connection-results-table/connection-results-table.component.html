<div class="connection-results-table">
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  } @else if (tableRows().length === 0) {
    <div class="no-results">
      <p class="body-text">No connection results found</p>
    </div>
  } @else {
    <table class="table">
      <thead>
      <tr>
        <th>Connected</th>
        <th>Client Account(s)</th>
        <th>Access Requested For</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
        @for (row of tableRows(); track row.id) {
          <tr [class.expanded]="isRowExpanded(row.id)" (click)="toggleRow(row.id)">
            <td>
              <div class="connection-info">
                <app-badge
                  [text]="getAccessBadgeText(row.accessType)"
                  [variant]="getAccessBadgeVariant(row.accessType)">
                </app-badge>
                <br>
                <span class="connection-time">{{ formatTime(row.connectionTime) }}</span>
              </div>
            </td>
            <td>
              <div class="client-accounts">
                <div class="counts-summary">
                  @if (row.successCount > 0) {
                    <app-badge
                      [text]="row.successCount + ' granted'"
                      variant="success">
                    </app-badge>
                  }
                  @if (row.failedCount > 0) {
                    <app-badge
                      [text]="row.failedCount + ' failed'"
                      variant="warning">
                    </app-badge>
                  }
                  @if (row.missingCount > 0) {
                    <app-badge
                      [text]="row.missingCount + ' not attempted'"
                      variant="info">
                    </app-badge>
                  }
                </div>
                @for (access of row.grantedAccesses; track access.entityId) {
                  <div class="account-item">
                    @if (access.success) {
                      <mat-icon class="success-icon">check_circle</mat-icon>
                    } @else {
                      <mat-icon class="warning-icon">warning</mat-icon>
                    }
                    @if (getServiceIcon(access.service)) {
                      <img [src]="getServiceIcon(access.service)"
                           [alt]="access.service"
                           class="service-icon">
                    }
                    <strong>{{ getServiceDisplayName(access.service) }}</strong>
                    <span class="entity-name">{{ access.entityId }}</span>
                    @if (access.linkId) {
                      <a [href]="getDeepLink('facebook', access.service, access.entityId, access.agencyIdentifier)"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="deep-link"
                        (click)="$event.stopPropagation()">
                        <mat-icon>open_in_new</mat-icon>
                      </a>
                    }
                  </div>
                }
              </div>
            </td>
            <td>
              <div class="platforms">
                @for (platform of row.platforms; track platform) {
                  @for (result of results(); track result._id) {
                    @if (result._id === row.id) {
                      <div class="platform-info">
                        <img
                          [src]="getPlatformIcon(platform)"
                          [alt]="platform"
                          class="platform-icon">
                        <strong>{{ getPlatformDisplayName(platform) }}</strong>
                        <span>{{ getPlatformBusinessName(result, platform) }}</span>
                      </div>
                    }
                  }
                }
              </div>
            </td>
            <td class="expand-icon-cell">
              <mat-icon class="expand-icon">{{ isRowExpanded(row.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
            </td>
          </tr>

          @if (isRowExpanded(row.id)) {
            <tr class="expanded-row">
              <td colspan="4">
                <div class="expanded-content">
                  <h4 class="subtitle-small">Connection Details</h4>
                  <div class="details-grid">
                    <div class="detail-item">
                      <span class="label">Connection ID:</span>
                      <span class="value">{{ row.id }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Connection Link:</span>
                      <span class="value">{{ row.connectionLink }}</span>
                    </div>
                    @if (row.connectionLinkSnapshot) {
                      <div class="detail-item">
                        <span class="label">Link Name:</span>
                        <span class="value">{{ row.connectionLinkSnapshot.name }}</span>
                      </div>
                    }
                    <div class="detail-item">
                      <span class="label">Access Type:</span>
                      <span class="value">{{ row.accessType }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Total Granted Accesses:</span>
                      <span class="value">{{ row.grantedAccesses.length }}</span>
                    </div>
                  </div>

                  @if (row.requestedServices.length > 0) {
                    <h4 class="subtitle-small comparison-title">Request vs Results Comparison</h4>
                    <div class="comparison-table">
                      <div class="comparison-header">
                        <div class="comparison-cell">Service</div>
                        <div class="comparison-cell">Requested For</div>
                        <div class="comparison-cell">Status</div>
                      </div>
                      @for (requested of row.requestedServices; track requested.service) {
                        @let status = getRequestStatus(row, requested);
                        @let statusClass = getRequestStatusClass(status);
                        @let statusIcon = getRequestStatusIcon(status);
                        @let serviceIcon = getServiceIcon(requested.service, requested.platform);
                        @let statusError = getErrorMessage(row, requested);

                        <div class="comparison-row" [ngClass]="statusClass">
                          <div class="comparison-cell service-cell">
                            @if (serviceIcon) {
                              <img [src]="serviceIcon" [alt]="requested.service" class="service-icon">
                            }
                            <span>{{ getServiceDisplayName(requested.service) }}</span>
                          </div>
                          <div class="comparison-cell identifier-cell">
                            <span>{{ requested.identifier }}</span>
                          </div>
                          <div class="comparison-cell status-cell">
                            <mat-icon [class]="statusClass">{{ statusIcon }}</mat-icon>
                            <span class="status-text">{{ getRequestStatusTitle(status) }}</span>
                            @if (status === 'failed' && statusError) {
                              <div class="error-message">{{ statusError }}</div>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  } @else {
                    <p class="no-snapshot-message body-text">No snapshot data available for this connection.</p>
                  }
                </div>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  }
</div>
